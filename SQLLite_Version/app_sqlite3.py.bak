from flask import Flask, render_template, request, redirect, url_for, g
import sqlite3
import os
import uuid
from datetime import datetime

# Tell Flask: use instance folder relative to project
app = Flask(__name__, instance_relative_config=True)

# Ensure instance folder exists
os.makedirs(app.instance_path, exist_ok=True)

# Database path inside instance folder
DATABASE = os.path.join(app.instance_path, 'notes.db')
app.config['DATABASE'] = DATABASE

def get_db():
    db = getattr(g, '_database', None)
    if db is None:
        db = g._database = sqlite3.connect(
            app.config['DATABASE'],
            detect_types=sqlite3.PARSE_DECLTYPES
        )
        db.row_factory = sqlite3.Row
    return db

@app.teardown_appcontext
def close_connection(exception):
    db = getattr(g, '_database', None)
    if db is not None:
        db.close()

def init_db():
    with app.app_context():
        db = get_db()
        cursor = db.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS notes (
                note_id TEXT PRIMARY KEY,
                note_content TEXT NOT NULL,
                timestamp TEXT NOT NULL
            );
        ''')
        db.commit()

# Initialize DB
init_db()

@app.route('/')
def index():
    db = get_db()
    cursor = db.cursor()
    cursor.execute("SELECT * FROM notes ORDER BY timestamp DESC")
    notes = cursor.fetchall()
    return render_template('index.html', notes=notes)

@app.route('/add_note', methods=['POST'])
def add_note():
    note_content = request.form.get('note_content')
    if note_content:
        note_id = str(uuid.uuid4())
        timestamp = datetime.utcnow().isoformat()
        db = get_db()
        db.execute("INSERT INTO notes (note_id, note_content, timestamp) VALUES (?, ?, ?)",
                   (note_id, note_content, timestamp))
        db.commit()
    return redirect(url_for('index'))

@app.route('/delete_note/<note_id>', methods=['POST'])
def delete_note(note_id):
    db = get_db()
    db.execute("DELETE FROM notes WHERE note_id = ?", (note_id,))
    db.commit()
    return redirect(url_for('index'))

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
