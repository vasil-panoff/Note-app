from flask import Flask, render_template, request, redirect, url_for, g
import sqlite3
import os
import uuid
from datetime import datetime
import os

# Get the absolute path of the directory the script is in
basedir = os.path.abspath(os.path.dirname(__file__))

# Define the path for the database file inside an 'instance' folder
DATABASE = os.path.join(basedir, 'instance', 'notes.db')

# Create the 'instance' directory if it doesn't exist
if not os.path.exists(os.path.dirname(DATABASE)):
    os.makedirs(os.path.dirname(DATABASE))

app = Flask(__name__)
app.config['DATABASE'] = DATABASE

# Function to get the database connection
def get_db():
    db = getattr(g, '_database', None)
    if db is None:
        db = g._database = sqlite3.connect(
            app.config['DATABASE'],
            detect_types=sqlite3.PARSE_DECLTYPES
        )
        db.row_factory = sqlite3.Row  # This allows accessing columns by name
    return db

# Function to close the database connection at the end of a request
@app.teardown_appcontext
def close_connection(exception):
    db = getattr(g, '_database', None)
    if db is not None:
        db.close()

# Function to initialize the database schema
def init_db():
    with app.app_context():
        db = get_db()
        cursor = db.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS notes (
                note_id TEXT PRIMARY KEY,
                note_content TEXT NOT NULL,
                timestamp TEXT NOT NULL
            );
        ''')
        db.commit()

# Call the initialization function when the script is run
# This ensures the table exists before the app starts
if not os.path.exists(DATABASE):
    print(f"Database not found. Creating {DATABASE}...")
    init_db()
    print("Database initialized.")


@app.route('/')
def index():
    db = get_db()
    cursor = db.cursor()
    cursor.execute("SELECT * FROM notes ORDER BY timestamp DESC")
    notes = cursor.fetchall()
    return render_template('index.html', notes=notes)

@app.route('/add_note', methods=['POST'])
def add_note():
    note_content = request.form.get('note_content')
    if note_content:
        note_id = str(uuid.uuid4())
        timestamp = datetime.utcnow().isoformat()
        db = get_db()
        cursor = db.cursor() # <-- CHANGE: Use a cursor
        cursor.execute("INSERT INTO notes (note_id, note_content, timestamp) VALUES (?, ?, ?)",
                       (note_id, note_content, timestamp))
        db.commit()
    return redirect(url_for('index'))

@app.route('/delete_note/<note_id>', methods=['POST'])
def delete_note(note_id):
    db = get_db()
    cursor = db.cursor() # <-- CHANGE: Use a cursor
    cursor.execute("DELETE FROM notes WHERE note_id = ?", (note_id,))
    db.commit()
    return redirect(url_for('index'))

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)